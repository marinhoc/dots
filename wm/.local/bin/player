#!/bin/sh
#
# player - media players control

die() {
    printf '%s\n' "${1:-usage : ${0##*/} <play-pause|previous|next>}" >&2

    exit 1
}

_() playerctl "$@"

# get list of media players
arg=$1

set -f
set -- $(_ -l 2> /dev/null)
set +f

test "$#" -gt 0 ||
    exit

# argument parsing
case $arg in
    previous|next)
        _ "$arg"

        # send a notification when fullscreen
        bspc query -N -n focused.fullscreen > /dev/null && {
            # wait for metadata to settle
            {
                sh -c 'echo $$; playerctl metadata -f "{{duration(position)}}" -F' | {
                    read -r pid
                    read -r _
                    read -r _

                    kill "$pid"
                }
            } 2> /dev/null

            dunstify -r 500 "$(_ metadata title)"
        }

        : # fix exit status
        ;;
    play-pause)
        # toggle most recent playing media player
        for player; do
            case $(_ -p "$player" metadata -f "{{status}}") in
                Playing) _ -p "$player" pause; exit
            esac
        done

        _ play
        ;;
    *)
        die
esac
